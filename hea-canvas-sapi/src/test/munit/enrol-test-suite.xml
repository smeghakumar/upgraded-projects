<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">
	<munit:config name="enrol-test-suite.xml" />
	<munit:test name="retrieve-course-enrollment-sub-flow-test" doc:id="5886dd5c-227f-48d0-9b9e-2a653b7c423d" description="Test to validate the successfull execution of get enrollments by courseid">
		<munit:behavior >
			<munit-tools:mock-when doc:name="request-canvas-sub-flow" doc:id="c4031f6f-e3dd-40e0-b281-2f632ebfba83" processor="flow-ref">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="request-canvas-sub-flow" attributeName="doc:name" />
					<munit-tools:with-attribute whereValue="c752960d-ab50-4b1d-ae2c-7549dca99ec4" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value="#[output application/json  --- readUrl('classpath://getenrollments/get_enrollment_response_payload.dwl')]" mediaType="application/json" encoding="UTF-8" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="courseid" doc:id="a537998f-c35c-4d23-ade4-0e83a033eae3" >
				<munit:variables >
					<munit:variable key="courseid" value="#[output application/json --- readUrl('classpath://getenrollments/get_enrollment_mock_variable.dwl')]&#10;" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name=" retrieve-course-enrollment-sub-flow" doc:id="4f2e748c-dac4-4bc8-a35c-96626cd28389" name="retrieve-course-enrollment-sub-flow"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert doc:name="Response Payload" doc:id="fac1d1ca-cfd6-467d-be25-a6a0183d44dc" >
				<munit-tools:that ><![CDATA[#[%dw 2.0
import getenrollments::assert_expression_payload
---
assert_expression_payload::main({payload: payload, attributes: attributes, vars: vars})]]]></munit-tools:that>
			</munit-tools:assert>
		</munit:validation>
	</munit:test>
	<munit:test name="get-enrol-exception-test" doc:id="fa8a1c16-1109-4cf6-b7ba-41e08b6ab036" description="Test to validate the negative scenario of get enrollments by courseid" expectedErrorType="CANVAS_SAPI:ENROLLMENT_NOT_FOUND">
		<munit:behavior>
			<munit-tools:mock-when doc:name="request-canvas-sub-flow" doc:id="c4f4e5de-7ebf-43fa-9ed6-0a4084844766" processor="flow-ref" >
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="request-canvas-sub-flow" attributeName="doc:name" />
					<munit-tools:with-attribute whereValue="c752960d-ab50-4b1d-ae2c-7549dca99ec4" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value='#["Error"]' mediaType="text/plain" />
					<munit-tools:variables >
						<munit-tools:variable key="isError" value="#[true]" />
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="courseid" doc:id="f8776615-0f71-4ffb-80a9-22de92786595">
				<munit:variables>
					<munit:variable key="courseid" value="#[output application/json --- readUrl('classpath://getenrollments/get_enrollment_mock_variable.dwl')]&#10;" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name=" retrieve-course-enrollment-sub-flow" doc:id="7145982e-1d66-4d5c-869a-c9ce82e09602" name="retrieve-course-enrollment-sub-flow" />
		</munit:execution>
	</munit:test>
  
    <munit:test name="create-course-enrollment-sub-flow-test" doc:id="9cf4a844-9520-4fa2-8af4-eb24d5f20388" description="Test to successful execution of creation of course enrollment">
    <munit:behavior >
      <munit-tools:mock-when doc:name="Canvas Api Call" doc:id="53239dc6-9d48-4ef4-9026-ca93bce50d05" processor="http:request">
        <munit-tools:with-attributes >
          <munit-tools:with-attribute whereValue="Canvas API" attributeName="doc:name" />
          <munit-tools:with-attribute whereValue="609d8e70-f848-469f-8436-39f66871fd4f" attributeName="doc:id" />
          <munit-tools:with-attribute whereValue="httpsCanvasRequestConfig" attributeName="config-ref" />
        </munit-tools:with-attributes>
        <munit-tools:then-return >
          <munit-tools:payload value="#[output application/json&#10;---&#10;readUrl('classpath://createCourseEnrollmentSubFlow/mock-canvas-call-response.dwl', &quot;application/json&quot;)]" />
        </munit-tools:then-return>
      </munit-tools:mock-when>
    </munit:behavior>
    <munit:execution >
      <set-payload value="#[readUrl('classpath://createCourseEnrollmentSubFlow/set-event-payload.dwl')]" doc:name="Request Payload" doc:id="052219b8-7753-4b8d-84c4-d1d1c2961687" />
      <munit:set-event doc:name="CourseId Variable" doc:id="65d53847-8891-4f2a-a2ac-9634d0dbbd89" >
        <munit:payload value="#[%dw 2.0&#10;output application/json&#10;---payload]" />
        <munit:variables >
          <munit:variable key="courseId" value="#[payload.courseId]" mediaType="application/json" />
        </munit:variables>
      </munit:set-event>
      <flow-ref doc:name="create-course-enrollment-sub-flow" doc:id="b0e80d98-d119-4f1b-bc17-5806b94f5246" name="create-course-enrollment-sub-flow"/>
    </munit:execution>
    <munit:validation >
      <munit-tools:assert-equals doc:name="Response Payload" doc:id="23f73ae9-c1d0-4604-8e20-919e2cf8a67b" actual="#[payload]" expected="#[readUrl('classpath://createCourseEnrollmentSubFlow/mock-canvas-response.dwl', &quot;application/json&quot;)]"/>
    </munit:validation>
  </munit:test>

</mule>
