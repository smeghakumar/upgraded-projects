<?xml version="1.0" encoding="UTF-8"?>

<mule
  xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/mule-ee.xsd">
  <sub-flow
    name="create-course-sub-flow"
    doc:id="cb73f2aa-fbf2-4bd5-9bac-377e52f31605">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="529a4738-cb09-4fd9-bf2f-c786c4e9372f"
      message="Start create-course-sub-flow"
      category="${logger.category}.create-course-sub-flow" />
    <ee:transform
      doc:name="Create Course Payload"
      doc:id="39a34424-cc71-42a4-a15d-24ab405b2339">
      <ee:message>
        <ee:set-payload resource="dwl/create-course-request.dwl" />
      </ee:message>
      <ee:variables>
        <ee:set-variable variableName="method"><![CDATA["POST"]]></ee:set-variable>
        <ee:set-variable variableName="canvasPath"><![CDATA[p('canvas.course.endpoint')]]></ee:set-variable>
      </ee:variables>
    </ee:transform>
    <logger
      level="INFO"
      doc:name="Before Canvas call"
      doc:id="8c2690f7-5fc0-4769-af1c-8f4a6e215911"
      message="Before request-canvas-sub-flow call"
      category="${logger.category}.create-course-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: Before Canvas call"
      doc:id="a6f8f28e-b46f-4525-a17b-1323db965888"
      message="#[payload]"
      category="${logger.category}.create-course-sub-flow" />
    <flow-ref
      doc:name="request-canvas-sub-flow"
      doc:id="9a57e5ad-de6e-4ce4-89e8-02d08887fecb"
      name="request-canvas-sub-flow" />
    <logger
      level="INFO"
      doc:name="After Canvas call"
      doc:id="506dc1d6-7d1b-496a-9421-74f7c9ff9068"
      message="After request-canvas-sub-flow call"
      category="${logger.category}.create-course-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: After Canvas call"
      doc:id="c338ff52-e8d2-465d-883e-5f21d47c2b30"
      message="#[payload]"
      category="${logger.category}.create-course-sub-flow" />
    <choice
      doc:name="Choice"
      doc:id="96a02c2c-6104-44b6-969f-a090e1fbe66c">
      <when expression="#[vars.isError == true]">
        <raise-error
          doc:name="CANVAS_SAPI:CREATE_COURSE_FAILED"
          doc:id="5a25c8ff-9ee8-4a52-9fd3-bad5da32cf1c"
          type="CANVAS_SAPI:CREATE_COURSE_FAILED"
          description="#[payload]" />
      </when>
      <otherwise>
        <logger
          level="INFO"
          doc:name="INFO Logger"
          doc:id="3d8afb8c-b2fa-4209-a26f-796f75b55cf4"
          message="Course created successfully"
          category="${logger.category}.create-course-sub-flow" />
        <ee:transform
          doc:name="Response Payload"
          doc:id="f0a1c4a3-6076-4f59-b709-529f2db7b966">
          <ee:message>
            <ee:set-payload resource="dwl/create-course-response.dwl" />
          </ee:message>
        </ee:transform>
      </otherwise>
    </choice>
    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="f48b5df1-4f71-4eee-8e68-e982c0c0cb7b"
      message="End create-course-sub-flow"
      category="${logger.category}.create-course-sub-flow" />
  </sub-flow>
  <sub-flow
    name="retrieve-course-by-field-sub-flow"
    doc:id="b5e1b93f-b957-430e-a1dc-f835bd841f3d">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="b0517ba2-06c8-4c53-9134-03fb6dec0f11"
      message="Start retrieve-course-by-field-sub-flow"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
    <ee:transform
      doc:name="Retrieve Course Request Payload"
      doc:id="a766314a-78c7-4886-a194-3d5a7f2e597e">
      <ee:message>
      </ee:message>
      <ee:variables>
        <ee:set-variable
          resource="dwl/retrieve-course-request.dwl"
          variableName="canvasPath" />
        <ee:set-variable variableName="method"><![CDATA["GET"]]></ee:set-variable>
      </ee:variables>
    </ee:transform>
    <logger
      level="INFO"
      doc:name="Before Canvas call"
      doc:id="4982367e-8a5c-4ba4-8f2f-b52ec39cbd68"
      message="Before request-canvas-sub-flow call"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: Before Canvas call"
      doc:id="0ff642c8-702a-4a4e-b7b2-d1dfcda9e80d"
      message="#[payload]"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
    <flow-ref
      doc:name="request-canvas-sub-flow"
      doc:id="60577df2-1218-4c78-9f74-a2a379ce5843"
      name="request-canvas-sub-flow" />
    <logger
      level="INFO"
      doc:name="After Canvas call"
      doc:id="39de1a85-8da0-4423-a810-1bfd96316bed"
      message="After request-canvas-sub-flow call"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: After Canvas call"
      doc:id="505e6e1e-afdb-4ea6-8aff-427fb32857eb"
      message="#[payload]"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
    <choice
      doc:name="isError"
      doc:id="41dbc618-8d5f-4670-9be2-c28bd9df7d42">
      <when expression="#[vars.isError == true]">
        <raise-error
          doc:name="CANVAS_SAPI:COURSE_NOT_FOUND"
          doc:id="42401293-8f05-465a-84e6-9aab099cf63d"
          type="CANVAS_SAPI:COURSE_NOT_FOUND"
          description="#[payload]" />
      </when>
      <otherwise>
        <logger
          level="INFO"
          doc:name="INFO Logger"
          doc:id="8e4a2032-f408-4fcf-810d-188283b875c6"
          message="Course retrieved successfully"
          category="${logger.category}.retrieve-course-by-field-sub-flow" />
        <ee:transform
          doc:name="Response Payload"
          doc:id="b1eee255-300f-4852-a93d-bfe803e99181">
          <ee:message>
            <ee:set-payload resource="dwl/retrieve-course-response.dwl" />
          </ee:message>

        </ee:transform>
      </otherwise>
    </choice>
    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="631db53c-5213-4624-b1ad-80ce5b359c83"
      message="End retrieve-course-by-field-sub-flow"
      category="${logger.category}.retrieve-course-by-field-sub-flow" />
  </sub-flow>
</mule>