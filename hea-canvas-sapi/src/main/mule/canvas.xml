<?xml version="1.0" encoding="UTF-8"?>

<mule
  xmlns:http="http://www.mulesoft.org/schema/mule/http"
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/mule.xsd">

  <sub-flow
    name="request-canvas-sub-flow"
    doc:id="b59a4f34-b432-4743-ba93-aeaa0c45ce81">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="73d0ae44-431a-4d63-b1b1-93f5127237e4"
      message="Start request-canvas-sub-flow"
      category="${logger.category}.request-canvas-sub-flow" />
    <try
      doc:name="Try"
      doc:id="84e28321-7637-4114-87d6-4119c987cc63">
      <until-successful
        maxRetries="${retry.numRetries}"
        doc:name="Until Successful"
        doc:id="9e184a15-0b71-4469-bd83-876d6045dd34"
        millisBetweenRetries="${retry.delayMillisecs}">
        <try
          doc:name="Try"
          doc:id="02be7277-179c-49de-8b32-07d64eccb140">
          <logger
            level="DEBUG"
            doc:name="DEBUG: Before Request Call"
            doc:id="c5d4a1fb-309d-4d87-9f11-e5018d1437e9"
            message="#[payload]"
            category="${logger.category}.request-canvas-sub-flow" />
          <set-variable
            value="#[false]"
            doc:name="isError = false"
            doc:id="855216a0-7295-48f4-920a-5c7561fe47f8"
            variableName="isError" />
          <http:request
            method="#[vars.method]"
            doc:name="Canvas API"
            doc:id="609d8e70-f848-469f-8436-39f66871fd4f"
            config-ref="httpsCanvasRequestConfig"
            path="#[vars.canvasPath]"
            responseTimeout="30000">
            <http:headers><![CDATA[#[output application/java ---
{
	"Authorization": "Bearer " ++ p('secure::canvas.token') 
}]]]></http:headers>
          </http:request>
          <logger
            level="DEBUG"
            doc:name="DEBUG: After Request Call"
            doc:id="a139e1c5-4a82-4bc9-ad4b-60075ab990fd"
            message="#[payload]"
            category="${logger.category}.request-canvas-sub-flow" />
          <choice
            doc:name="Choice"
            doc:id="3b766a01-5b30-4202-a604-b8979945f46c">
            <when
              expression='#[(payload != null) and (typeOf(payload) as String == "Object") and (keysOf(payload)[0] as String == "exception")]'>
              <logger
                level="INFO"
                doc:name="INFO Logger"
                doc:id="2b27c0a7-bf12-41fb-b0d4-d6903d9cb426"
                message="Exception occurred."
                category="${logger.category}.request-canvas-sub-flow" />
              <set-variable
                value="#[true]"
                doc:name="isError = true"
                doc:id="68541eba-317e-4136-854b-84a9ae9f82fc"
                variableName="isError" />
              <set-payload
                value="#[payload.message]"
                doc:name="error.description "
                doc:id="aef4abc1-7cbc-4b79-b96d-232e78077627" />
            </when>
            <otherwise>
              <logger
                level="INFO"
                doc:name="INFO Logger"
                doc:id="dee0a2e5-a80d-482a-bc14-7513c16e18aa"
                message="Canvas response has no exception."
                category="${logger.category}.request-canvas-sub-flow" />
            </otherwise>
          </choice>
          <error-handler>
            <on-error-propagate
              enableNotifications="true"
              logException="true"
              doc:name="On Error Propagate"
              doc:id="b74ad5c5-2a5a-4434-a025-64fec515c719"
              when="#[((['CONNECTIVITY','INTERNAL_SERVER','TIMEOUT', 'TOO_MANY_REQUESTS'] contains error.errorType.identifier))]">
              <set-variable
                value="#[true]"
                doc:name="isError = true"
                doc:id="c14c8c8d-b6be-4ae5-8a4d-051aac570908"
                variableName="isError" />
              <set-payload
                value="#[error.description]"
                doc:name="error.description "
                doc:id="f7e9622b-4040-4506-a475-7de516773e2e" />
            </on-error-propagate>
            <on-error-continue
              enableNotifications="true"
              logException="true"
              doc:name="On Error Continue"
              doc:id="18c81fd6-e1fb-4769-a92c-8a371ed88714">
              <set-variable
                value="#[true]"
                doc:name="isError = true"
                doc:id="037fabf8-af81-4e3f-b841-f41d1ad167e3"
                variableName="isError" />
              <set-payload
                value="#[error.description]"
                doc:name="error.description "
                doc:id="04a74adb-d806-40ae-9e21-71a075405480" />
            </on-error-continue>
          </error-handler>
        </try>
      </until-successful>
      <error-handler>
        <on-error-continue
          enableNotifications="true"
          logException="true"
          doc:name="On Error Continue"
          doc:id="f607a644-f9c9-46ee-a559-cd5ff7a55345">
          <set-variable
            value="#[true]"
            doc:name="isError = true"
            doc:id="db009fc1-c7d2-489f-99bd-0e1d44d2119a"
            variableName="isError" />
          <set-payload
            value="#[error.description]"
            doc:name="error.description "
            doc:id="10068438-7027-4802-93e7-de57a367e2ef" />
        </on-error-continue>
      </error-handler>

    </try>
    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="929ae0a2-845a-4f27-b145-c521dd321b7b"
      message="End request-canvas-sub-flow"
      category="${logger.category}.request-canvas-sub-flow" />
  </sub-flow>
</mule>
