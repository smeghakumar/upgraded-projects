<?xml version="1.0" encoding="UTF-8"?>

<mule
  xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/mule.xsd">
  <sub-flow
    name="create-user-sub-flow"
    doc:id="42b34554-c45f-4f87-9424-dfe255f88061">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="25130fd5-0704-4a0e-a9a3-877849feb7d7"
      message="Start create-user-sub-flow"
      category="${logger.category}.create-user-sub-flow" />
    <ee:transform
      doc:name="Create User Payload and Path Variable"
      doc:id="f551f572-07b6-4469-954d-d4f62ee36cd9">
      <ee:message>
        <ee:set-payload resource="dwl/create-user-request.dwl" />
      </ee:message>
      <ee:variables>
        <ee:set-variable variableName="method"><![CDATA["POST"]]></ee:set-variable>
        <ee:set-variable variableName="canvasPath"><![CDATA[p('canvas.user.endpoint')]]></ee:set-variable>
      </ee:variables>
    </ee:transform>
    <logger
      level="INFO"
      doc:name="Before Request Canvas Call"
      doc:id="14eee2fa-ebd8-42ff-a058-ff22934376ea"
      message="Before Request Canvas Call"
      category="${logger.category}.create-user-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG:Before Request Canvas Call"
      doc:id="ec7b734a-45e2-4d77-9b85-653142f1aba4"
      message="#[payload]"
      category="${logger.category}.create-user-sub-flow" />
    <flow-ref
      doc:name="request-canvas-sub-flow"
      doc:id="ef05781f-a800-47a3-9614-72847989a79b"
      name="request-canvas-sub-flow" />
    <logger
      level="INFO"
      doc:name="After Request Canvas Call"
      doc:id="c1a66a56-690f-4df8-93f2-fb3f61d2948d"
      message="After Request Canvas Call"
      category="${logger.category}.create-user-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG:After Request Canvas Call"
      doc:id="1d362fd1-d222-4ee1-b3fb-d0578ffd4766"
      message="#[payload]"
      category="${logger.category}.create-user-sub-flow" />
    <choice
      doc:name="Choice"
      doc:id="4cd94b62-853a-4e8d-a4fa-525433acf0f3">
      <when expression="#[vars.isError == true]">
        <raise-error
          doc:name="CANVAS_SAPI:CREATE_USER_FAILED"
          doc:id="01a5d4f2-b538-499e-a42f-0b8507f3c9bd"
          type="CANVAS_SAPI:CREATE_USER_FAILED"
          description="#[payload]" />
      </when>
      <otherwise>
        <logger
          level="INFO"
          doc:name="INFO Logger"
          doc:id="3b92a2e1-e45c-4caf-927e-2c05b4b299f1"
          message="User created successfully"
          category="${logger.category}.create-user-sub-flow" />
      </otherwise>
    </choice>

    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="ee531405-360c-4bab-b670-6bd966ab5e3e"
      message="End create-user-sub-flow"
      category="${logger.category}.create-user-sub-flow" />
  </sub-flow>
  <sub-flow
    name="get-user-by-criteria-sub-flow"
    doc:id="a0c01842-75a3-43a0-818a-cb4a4ec7aa2a">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="38c8973e-f913-41cf-942a-b57fc7a16d3e"
      message="Start get-user-by-criteria-sub-flow"
      category="${logger.category}.get-user-by-criteria-sub-flow" />
    <ee:transform
      doc:name="Get User Payload"
      doc:id="5d985488-686e-4c09-92e3-21b564d256f8">
      <ee:message>
        <ee:set-payload resource="dwl/get-user-request.dwl" />
      </ee:message>
    </ee:transform>
    <choice
      doc:name="Check Payload"
      doc:id="032f3032-a94d-4eee-ace5-1323076e43fd">
      <when expression='#[!isEmpty(payload.message)]'>
        <logger
          level="INFO"
          doc:name="INFO Logger"
          doc:id="4d374d23-d26c-4a4b-8b71-b1535f47e3e1"
          message="Invalid search criteria"
          category="${logger.category}.get-user-by-criteria-sub-flow" />
      </when>
      <otherwise>
        <ee:transform
          doc:name="Set Variables"
          doc:id="22a16830-7ebd-4237-89bc-8fde6fa1b490">
          <ee:message>
          </ee:message>
          <ee:variables>
            <ee:set-variable variableName="method"><![CDATA["GET"]]></ee:set-variable>
            <ee:set-variable variableName="canvasPath"><![CDATA[output application/json --- p('canvas.user.endpoint') ++ "?search_term=" ++ payload.key]]></ee:set-variable>
          </ee:variables>
        </ee:transform>
        <logger
          level="INFO"
          doc:name="Before Request Canvas Call"
          doc:id="a789ed3d-961c-4b20-8c6d-e4ef4a460cce"
          message="Before Request Canvas Call"
          category="${logger.category}.get-user-by-criteria-sub-flow" />
        <logger
          level="DEBUG"
          doc:name="DEBUG: Before Request Canvas Call"
          doc:id="71147ca0-fef2-4142-966c-47266446b6ec"
          message="#[payload]"
          category="${logger.category}.get-user-by-criteria-sub-flow" />
        <flow-ref
          doc:name="request-canvas-sub-flow"
          doc:id="039bc8da-3e94-4f5b-9b49-3d9bd84180a4"
          name="request-canvas-sub-flow" />
        <logger
          level="INFO"
          doc:name="After Request Canvas Call"
          doc:id="7050e5e5-2add-4b3c-9dec-d1aa5be79114"
          message="After Request Canvas Call"
          category="${logger.category}.get-user-by-criteria-sub-flow" />
        <logger
          level="DEBUG"
          doc:name="DEBUG: After Request Canvas Call"
          doc:id="16635619-bd20-4a38-8ba5-50934afa002e"
          message="#[payload]"
          category="${logger.category}.get-user-by-criteria-sub-flow" />
        <choice
          doc:name="Is Error Check"
          doc:id="9973ba9d-fde1-4ecf-80f8-7313e1e3fa16">
          <when expression="#[vars.isError == true]">
            <raise-error
              doc:name="CANVAS_SAPI:GET_USER_FAILED"
              doc:id="9e60a756-13b5-4133-abea-f9240f9a10cd"
              type="CANVAS_SAPI:GET_USER_FAILED"
              description="#[payload]" />

          </when>
          <otherwise>
            <logger
              level="INFO"
              doc:name="INFO Logger"
              doc:id="99e33a19-4581-4937-aa4c-990f31c20da3"
              message="User details fetched successfully"
              category="${logger.category}.get-user-by-criteria-sub-flow" />
            <ee:transform
              doc:name="Response Payload"
              doc:id="a31a9c25-347d-4925-b4d1-937f5d136d5c">
              <ee:message>
                <ee:set-payload resource="dwl/get-user-response.dwl" />
              </ee:message>
            </ee:transform>
          </otherwise>
        </choice>
      </otherwise>
    </choice>
    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="4efef975-2908-4778-ad55-15050eb8eb9c"
      message="End get-user-by-id-sub-flow"
      category="${logger.category}.get-user-by-criteria-sub-flow" />
  </sub-flow>

  <sub-flow
    name="get-user-by-userid-sub-flow"
    doc:id="8b705fe1-b6ff-4a5c-998b-b9f32829a70a">
    <logger
      level="INFO"
      doc:name="Start Logger"
      doc:id="dccc6805-bd4f-477c-a647-be0a5730225c"
      message="Start get-user-by-userid-sub-flow"
      category="${logger.category}.get-user-by-userid-sub-flow" />
    <ee:transform
      doc:name="Set Variables"
      doc:id="8cfe4303-6f05-4e1f-84e3-931449a0a473">
      <ee:message>
      </ee:message>
      <ee:variables>
        <ee:set-variable variableName="method"><![CDATA["GET"]]></ee:set-variable>
        <ee:set-variable variableName="canvasPath"><![CDATA[output application/json --- p('canvas.user.get-endpoint') ++ "/" ++ attributes.uriParams.userid]]></ee:set-variable>
      </ee:variables>
    </ee:transform>
    <logger
      level="INFO"
      doc:name="Before Request Canvas Call"
      doc:id="d5b2fcb2-18dc-42c1-a053-2032fe8b9306"
      message="Before Request Canvas Call"
      category="${logger.category}.get-user-by-userid-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: Before Request Canvas Call"
      doc:id="2899eb9d-7988-44b4-8cbe-e7d92cf056aa"
      message="#[payload]"
      category="${logger.category}.get-user-by-userid-sub-flow" />
    <flow-ref
      doc:name="request-canvas-sub-flow"
      doc:id="1c936d91-1fad-4957-b3bf-d43f8951b0d9"
      name="request-canvas-sub-flow" />
    <logger
      level="INFO"
      doc:name="After Request Canvas Call"
      doc:id="21128383-a450-49df-9e91-492f4aa6e40f"
      message="After Request Canvas Call"
      category="${logger.category}.get-user-by-userid-sub-flow" />
    <logger
      level="DEBUG"
      doc:name="DEBUG: After Request Canvas Call"
      doc:id="9c780b1e-2be3-4c98-9d1b-507d54d7e15a"
      message="#[payload]"
      category="${logger.category}.get-user-by-userid-sub-flow" />
    <choice
      doc:name="Is Error Check"
      doc:id="8ad28ce9-c36e-4e57-afad-9760f859eb17">
      <when expression="#[vars.isError == true]">
        <raise-error
          doc:name="CANVAS_SAPI:GET_USER_FAILED"
          doc:id="7e6a6ae8-0dff-4373-99b4-acd0cfff2182"
          type="CANVAS_SAPI:GET_USER_FAILED"
          description="#[payload]" />

      </when>
      <otherwise>
        <logger
          level="INFO"
          doc:name="INFO Logger"
          doc:id="e31ca972-9db9-4b09-b4c7-32893eef6072"
          message="User details fetched successfully"
          category="${logger.category}.get-user-by-userid-sub-flow" />
        <ee:transform
          doc:name="Response Payload"
          doc:id="522f0249-45e3-4fe5-aa96-5d8714a6d498">
          <ee:message>
            <ee:set-payload resource="dwl/get-user-byid-response.dwl" />
          </ee:message>
        </ee:transform>
      </otherwise>
    </choice>
    <logger
      level="INFO"
      doc:name="End Logger"
      doc:id="19a007b4-92f4-4591-9d23-828b894b7aed"
      message="End get-user-by-userid-sub-flow"
      category="${logger.category}.get-user-by-userid-sub-flow" />
  </sub-flow>
</mule>
