<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	<sub-flow name="request-okta-sub-flow" doc:id="44733cc7-eef2-4513-921f-d890bad8ca83" >
		<logger level="INFO" doc:name="Start Logger" doc:id="d25a333c-9293-45eb-92c7-1d9fd7bd0d47" message="Start request-okta-sub-flow" category="${logger.category}.request-okta-sub-flow" />
		<try doc:name="Try" doc:id="cf99ff6c-2de7-4b8f-baa1-ae9ebcfee061" >
			<until-successful maxRetries="${retry.numRetries}" doc:name="Until Successful" doc:id="0179dc0b-3be2-4d6d-bb30-21f2b4684102" millisBetweenRetries="${retry.delayMillisecs}" >
				<try doc:name="Try" doc:id="0ef2cc51-23f3-4cb7-9273-a4c0fc008dbb" >
					<logger level="DEBUG" doc:name="DEBUG: Before Request Call" doc:id="da0651f3-3330-430c-b2ed-fc0311d42187" message="#[payload]" category="${logger.category}.request-okta-sub-flow" />
					<set-variable value="#[false]" doc:name="isError = false" doc:id="b936c90c-a8ae-4a4a-971c-656b80100e32" variableName="isError" />
					<choice doc:name="Check queryParams" doc:id="c0ae8d12-0320-4fdb-8dbc-59798cb9d78e" >
						<when expression="#[!isEmpty(vars.queryParams)]">
							<http:request method="#[vars.method]" doc:name="Okta HTTP Request with Query Parameters" doc:id="f45d7024-8177-4552-bc1a-1aa17e350304" config-ref="httpOktaRequestConfiguration" path="#[vars.path]" sendCorrelationId="ALWAYS">
								<http:body ><![CDATA[#[vars.requestPayload]]]></http:body>
								<http:query-params ><![CDATA[#[output application/java
---
vars.queryParams]]]></http:query-params>
					</http:request>
						</when>
						<otherwise >
							<http:request method="#[vars.method]" doc:name="Okta HTTP Request" doc:id="9c26d901-ab94-4104-aa0f-c850648edba8" config-ref="httpOktaRequestConfiguration" path="#[vars.path]" sendCorrelationId="ALWAYS">
						<http:body><![CDATA[#[vars.requestPayload]]]></http:body>
					</http:request>
						</otherwise>
					</choice>
					<logger level="DEBUG" doc:name="DEBUG: After Request Call" doc:id="af0f6985-1dd1-47ad-ab01-0dd88641058e" message="#[payload]" category="${logger.category}.request-okta-sub-flow" />
					<error-handler >
						<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="6b05596b-4bdc-4cb0-9989-abc8f4e68ca6" when="#[((['CONNECTIVITY','INTERNAL_SERVER','TIMEOUT', 'TOO_MANY_REQUESTS'] contains error.errorType.identifier))]" >
							<set-variable value="#[true]" doc:name="isError = true" doc:id="75777240-331a-4d70-989d-6f61c5f3298d" variableName="isError" />
							<set-payload value="#[error.description]" doc:name="error.description " doc:id="f6e5b439-543e-4df2-a1f1-fac716299f8a" />
						</on-error-propagate>
						<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="05821136-5b4b-4014-8093-69937a421d39" >
							<set-variable value="#[true]" doc:name="isError = true" doc:id="7a8babce-061a-4321-9cbc-7652e5c6f3cf" variableName="isError" />
							<set-payload value="#[error.description]" doc:name="error.description " doc:id="92956a2c-a5c5-41e2-8590-02942f8cf537" />
						</on-error-continue>
					</error-handler>
				</try>
			</until-successful>
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="2a38b72e-fabd-4894-95e1-2e59ac8e4004" >
					<set-variable value="#[true]" doc:name="isError = true" doc:id="2095981a-b1ee-45a3-8290-ed2da4086c5a" variableName="isError" />
					<set-payload value="#[error.description]" doc:name="error.description " doc:id="244de59d-8ea4-4d8a-ae6f-e9b0bdafe6cb" />
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="INFO" doc:name="End Logger" doc:id="dff7f14a-afa0-4670-ae76-4778296ac7ef" message="End request-okta-sub-flow" category="${logger.category}.request-okta-sub-flow" />
	</sub-flow>
</mule>
